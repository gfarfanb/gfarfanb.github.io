<!DOCTYPE html>
<html>
<head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
    $(document).ready(function()
    {
        let data = new Map();
        data.set('número de jugadores real', {
            currency: false,
            aliases: [
                'número de jugadores',
                '# de jugadores',
                '# de jugadores real',
                'núm. jugadores',
                '# jugadores'
            ]
        });
        data.set('número de jugadores meta', {
            currency: false,
            aliases: [
                '# de jugadores meta'
            ]
        });
        data.set('número de vendedores real', {
            currency: false,
            aliases: [
                'de vendedores real',
                'número de vendedores',
                'núm. de vendedores',
                '# de vendedores'
            ]
        });
        data.set('número de vendedores meta', {
            currency: false,
            aliases: [
                'de vendedores meta',
                'de vendedores un meta'
            ]
        });
        data.set('maletas real', {
            currency: false,
            aliases: [
                'maleta real',
                'maletas'
            ]
        });
        data.set('maletas meta', {
            currency: false,
            aliases: [
                'maleta meta',
                'de maletas met'
            ]
        });
        data.set('demos real', {
            currency: false,
            aliases: [
            ]
        });
        data.set('demos meta', {
            currency: false,
            aliases: [
            ]
        });
        data.set('citas instantáneas real', {
            currency: false,
            aliases: [
                'citas instantáneas',
                'cita instantánea real',
                'cita instantánea',
                'instantáneas'
            ]
        });
        data.set('citas instantáneas meta', {
            currency: false,
            aliases: [
                'cita instantánea meta'
            ]
        });
        data.set('citas real', {
            currency: false,
            aliases: [
                'citas'
            ]
        });
        data.set('citas meta', {
            currency: false,
            aliases: [
            ]
        });
        data.set('4/14 real', {
            currency: false,
            aliases: [
            ],
            canBeGrouped: true
        });
        data.set('4/14 meta', {
            currency: false,
            aliases: [
            ],
            canBeGrouped: true
        });
        data.set('referidos real', {
            currency: false,
            aliases: [
                'referidos'
            ],
            anotherExpectedKeys: [
                'número de ventas meta',
                'número de ventas real',
                'ventas meta',
                'ventas real',
                'ventas agregado'
            ]
        });
        data.set('referidos meta', {
            currency: false,
            aliases: [
                '# referidos meta'
            ],
            anotherExpectedKeys: [
                'número de ventas meta',
                'número de ventas real',
                'ventas meta',
                'ventas real',
                'ventas agregado'
            ]
        });
        data.set('número de ventas real', {
            currency: false,
            aliases: [
                'número de ventas',
                '# ventas real',
                '#ventas real',
                'numer de ventas real'
            ],
            maxExpected: 50,
            canBeGrouped: true,
            related: 'ventas real'
        });
        data.set('número de ventas meta', {
            currency: false,
            aliases: [
                '# ventas meta',
                '#ventas meta'
            ],
            maxExpected: 100,
            canBeGrouped: true,
            related: 'ventas meta'
        });
        data.set('ventas real', {
            currency: true,
            aliases: [
                'monto de venta',
                'monto real',
                'importe real',
                'real monto',
                'monto'
            ],
            canBeGrouped: true
        });
        data.set('ventas agregado', {
            currency: true,
            aliases: [
                'venta agregado',
                'ventas de agregado',
                'importe de agregado'
            ],
            canBeGrouped: true
        });
        data.set('ventas meta', {
            currency: true,
            aliases: [
                'monto meta',
                'meta monto'
            ],
            canBeGrouped: true
        });
        data.set('nuevos pros', {
            currency: false,
            aliases: [
                'nuevos ptos reclutamiento',
                'nuevos ptos en reclutamiento',
                'nuevos para reclutamiento',
                'nuevos pro reclutamiento',
                'nvos pros reclutamiento'
            ]
        });
        data.set('reclutamiento calido', {
            currency: false,
            aliases: [
            ]
        });
        data.set('reclutamiento real', {
            currency: false,
            aliases: [
                'rrhh real',
                'rh'
            ]
        });
        data.set('meta de reclutamiento', {
            currency: false,
            aliases: [
                'meta rrhh',
                'meta reclutamiento',
                'meta de reclut'
            ]
        });
        data.set('entrevistas', {
            currency: false,
            aliases: [
                'enztrevistas'
            ],
            anotherExpectedKeys: [
                'invitaciones'
            ]
        });
        data.set('invitaciones', {
            currency: false,
            aliases: [
            ],
            anotherExpectedKeys: [
                'entrevistas'
            ]
        });
        data.set('ingresos', {
            currency: false,
            aliases: [
            ]
        });
        data.set('telemarketing', {
            currency: false,
            aliases: [
            ]
        });
        data.set('prospectadores', {
            currency: false,
            aliases: [
            ]
        });
        data.set('invitados', {
            currency: false,
            aliases: [
            ]
        });

        let keywords = new Map();
        data.forEach(function (value, key) {
            keywords.set(key, key);
            value.aliases.forEach(function (alias) {
                keywords.set(alias, key);
            });
        });
        let keywordsArray = [...keywords];
        let keywordsSorted = keywordsArray.sort(
            ([key1, value1], [key2, value2]) => key2.length - key1.length
        );
        keywords = new Map(keywordsSorted);

        let pesos = new Intl.NumberFormat('es-MX', {
            currency: 'MXN',
            style: 'currency',
        });

        function generateId() {
            let id = "";
            let characters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
            for(let i = 0; i < 12; i++) {
                id += characters.charAt(Math.floor(Math.random() * 36));
            }
            return id;
        }

        let counters;
        function initCounters() {
            counters = new Map();
            data.forEach(function (value, key) {
                let keyword = key.toLowerCase();
                let counter = {
                    id: generateId(),
                    key: key,
                    counter: 0,
                    elements: []
                };
                counters.set(keyword, counter);
            });
        }

        function processLine(i, originalLine, keyword, masterKeyword) {
            let line = clearLine(originalLine);

            if(line.includes(keyword)) {
                let counter = counters.get(masterKeyword);

                if(counter) {
                    return processLineParts(i, originalLine, line, keyword, counter);
                } else {
                    return false;
                }
            } else {
                return false;
            }
        }

        function processLineParts(i, originalLine, line, keyword, counter) {
            let config = data.get(counter.key);

            if(config.anotherExpectedKeys) {
                let lineParts = extractLines(line);
                let expectedKeys = Array.from(config.anotherExpectedKeys);

                expectedKeys.push(counter.key);

                let expectedKeywords = getExpectedKeywords(expectedKeys);

                lineParts.forEach(function (linePart) {
                    let accepted = false;

                    expectedKeywords.forEach(function (expectedMasterKeyword, expectedKeyword) {
                        if(accepted) {
                            return;
                        }

                        linePart = clearLine(linePart);

                        if(linePart.includes(expectedKeyword)) {
                            let expectedCounter = counters.get(expectedMasterKeyword);
                            let fromField = (expectedMasterKeyword === counter.key ? null : counter.key);
                            countLine(i, originalLine, linePart, expectedKeyword, expectedCounter, fromField);
                            accepted = true;
                        }
                    });
                });
            } else {
                countLine(i, originalLine, line, keyword, counter, null);
            }

            return true;
        }

        function countLine(i, originalLine, line, keyword, counter, fromField) {
            let position = line.search(keyword);
            let rightPart = line.substring(position + keyword.length, line.length);
            let config = data.get(counter.key);

            if(config.canBeGrouped) {
                let grouped = getGroupedValues(i, originalLine, rightPart);
                if(grouped.found) {
                    assignValues(i, originalLine, counter, grouped.left, grouped.right, fromField);
                } else {
                    let lineValue = getLineValue(rightPart);
                    assignValues(i, originalLine, counter, 1, lineValue, fromField);
                }
            } else {
                let lineValue = getLineValue(rightPart);
                assignValues(i, originalLine, counter, 1, lineValue, fromField);
            }
        }

        function clearLine(line) {
            line = line.replace(/\s+/g, ' ');

            line = line.replace('1️⃣', '1');
            line = line.replace('2️⃣', '2');
            line = line.replace('3️⃣', '3');
            line = line.replace('4️⃣', '4');
            line = line.replace('5️⃣', '5');
            line = line.replace('6️⃣', '6');
            line = line.replace('7️⃣', '7');
            line = line.replace('8️⃣', '8');
            line = line.replace('9️⃣', '9');
            line = line.replace('🔟', '10');
            line = line.replace('0️⃣', '0');
            line = line.replace(' ', ' ');

            return line.toLowerCase();
        }

        function extractLines(line) {
            let parts = line.split(/ /);
            let lines = Array.of('');

            for(let i = 0; i < parts.length; i++) {
                let part = parts[i];

                if (!part && part.length == 0) {
                    continue;
                }

                let value = parseValue(part);

                if(isNaN(value)) {
                    lines[lines.length - 1] += (part + ' ');
                } else {
                    lines[lines.length - 1] += (value + ' ');
                    lines.push('');
                }
            }

            return lines;
        }

        function getExpectedKeywords(anotherExpectedKeys) {
            let expectedKeywords = new Map();
            keywords.forEach(function (masterKeyword, keyword) {
                if(anotherExpectedKeys.includes(masterKeyword)) {
                    expectedKeywords.set(keyword, masterKeyword);
                }
            });
            return expectedKeywords;
        }

        function getLineValue(line) {
            let quantity = parseValue(line);
            return isNaN(quantity) ? 0 : quantity;
        }

        function parseValue(line) {
            return parseInt(line.replace(/[^\d.-]/g, ''));
        }

        function getGroupedValues(i, originalLine, rightPart) {
            let delimiterPosition = getDelimiterPosition(rightPart);
            if(delimiterPosition != -1) {
                let groupedLeft = rightPart.substring(0, delimiterPosition);
                let groupedRight = rightPart.substring(delimiterPosition + 1, rightPart.length);
                let quantityLeft = parseValue(groupedLeft);
                let quantityRight = parseValue(groupedRight);
                return {
                    left: isNaN(quantityLeft) ? 1 : quantityLeft,
                    right: isNaN(quantityRight) ? 0 : quantityRight,
                    found: true
                };
            } else {
                return {
                    left: 0,
                    right: 0,
                    found: false
                };
            }
        }

        function getDelimiterPosition(rightPart) {
            let dollarPosition = rightPart.search('\\$');
            let separatorPosition = rightPart.search('\\/');
            if(dollarPosition > separatorPosition) {
                return dollarPosition;
            } else if(separatorPosition > dollarPosition) {
                return separatorPosition;
            } else {
                return -1;
            }
        }

        function assignValues(i, originalLine, counter, leftValue, rightValue, fromField) {
            let lineValue = (leftValue * rightValue);
            let config = data.get(counter.key);

            fromField = (fromField !== null
                    ? '<spam class="tag">[OBTENIDO DE GRUPO: <b>' + fromField + '</b>]</spam> '
                    : '');

            if(config.maxExpected && lineValue > config.maxExpected) {
                let relatedCounter = counters.get(config.related);
                if(relatedCounter) {
                    counter.counter += leftValue;
                    counter.elements.push(
                        '<spam class="tag">[ENVIADO A GRUPO: <b>' + config.related + '</b>]</spam> '
                        + fromField
                        + originalLine);

                    relatedCounter.counter += lineValue;
                    relatedCounter.elements.push(
                        '<spam class="tag">[OBTENIDO DE GRUPO: <b>' + counter.key + '</b>]</spam> '
                        + originalLine);
                } else {
                    counter.counter += lineValue;
                    counter.elements.push(fromField +  originalLine);
                }
            } else {
                counter.counter += lineValue;
                counter.elements.push(fromField + originalLine);
            }
        }

        function cleanCount() {
            initCounters();
            $('#info').val('');
            $('#results').text('');
            $('#discarded').text('');
        }

        $('#count').click(function() {
            let txt = $('#info').val();

            cleanCount();

            let lines = txt.split(/\n/);
            let discarded = '<ul>';

            for(let i = 0; i < lines.length; i++) {
                let originalLine = lines[i].trim();
                let accepted = false;

                if (!originalLine && originalLine.length == 0) {
                    continue;
                }

                keywords.forEach(function (masterKeyword, keyword) {
                    if(accepted) {
                        return;
                    }
                    accepted = processLine(i, originalLine, keyword, masterKeyword);
                });

                if(!accepted) {
                    discarded += '<li>' + originalLine + '</li>';
                }
            }
            discarded += '</ul>'

            let results = '<table>';
            counters.forEach(function (value, key) {
                let config = data.get(key);
                results += '<tr>';
                results += '<td>' + key + '</td>';
                if(config.currency) {
                    results += '<td>' + pesos.format(value.counter) + '</td>';
                } else {
                    results += '<td>' + value.counter + '</td>';
                }
                results += '<td>';
                results += '<button id="details-' + value.id + '">Detalle</button>';
                results += '<button id="hide-' + value.id + '">Ocultar</button>';
                results += '<ul id="list-' + value.id + '">';
                value.elements.forEach(function (element) {
                    results += '<li>' + element + '</li>';
                });
                results += '</ul>';
                results += '</td>';
                results += '</tr>';
            });
            results += "</table>"

            $('#results').html(results);
            $('#discarded').html(discarded);

            counters.forEach(function (value, key) {
                $("#list-" + value.id).hide();
                $("#hide-" + value.id).hide();

                $("#details-" + value.id).click(function(){
                    $("#list-" + value.id).show();
                    $("#details-" + value.id).hide();
                    $("#hide-" + value.id).show();
                });

                $("#hide-" + value.id).click(function(){
                    $("#list-" + value.id).hide();
                    $("#details-" + value.id).show();
                    $("#hide-" + value.id).hide();
                });
            });
        });

        $('#clean').click(function() {
            cleanCount();
        });

        initCounters();
    });
</script>
<style>
    footer {
        text-align: center;
        color: gray;
    }

    .tag {
        color: orange;
    }
</style>
</head>
<body>

<h3>Analizador de informes</h3>

<p>Pega los informes en la caja de texto</p>

<textarea id="info" rows="10" cols="50">
</textarea>

<br>
<button id="count">Contar</button>
<button id="clean">Limpiar</button>

<h4>Resultados</h4>
<div id="results"></div>

<h4>Líneas no leídas</h4>
<div id="discarded"></div>

<footer>
    <p>2022.03.15.15.18</p>
</footer>

</body>
</html>
