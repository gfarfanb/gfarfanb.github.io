<!DOCTYPE html>
<html>
<head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
    $(document).ready(function()
    {
        let data = new Map();
        data.set('n√∫mero de jugadores real', {
            currency: false,
            aliases: [
                'n√∫mero de jugadores',
                '# de jugadores',
                '# de jugadores real',
                'n√∫m. jugadores'
            ]
        });
        data.set('n√∫mero de jugadores meta', {
            currency: false,
            aliases: [
                '# de jugadores meta'
            ]
        });
        data.set('n√∫mero de vendedores real', {
            currency: false,
            aliases: [
                'de vendedores real',
                'n√∫mero de vendedores',
                'n√∫m. de vendedores',
                '# de vendedores'
            ]
        });
        data.set('n√∫mero de vendedores meta', {
            currency: false,
            aliases: [
                'de vendedores meta',
                'de vendedores un meta'
            ]
        });
        data.set('maletas real', {
            currency: false,
            aliases: [
                'maleta real'
            ]
        });
        data.set('maletas meta', {
            currency: false,
            aliases: [
                'maleta meta',
                'de maletas met'
            ]
        });
        data.set('demos real', {
            currency: false,
            aliases: [
            ]
        });
        data.set('demos meta', {
            currency: false,
            aliases: [
            ]
        });
        data.set('citas instant√°neas real', {
            currency: false,
            aliases: [
                'citas instant√°neas',
                'cita instant√°nea real',
                'cita instant√°nea',
                'instant√°neas'
            ]
        });
        data.set('citas instant√°neas meta', {
            currency: false,
            aliases: [
                'cita instant√°nea meta'
            ]
        });
        data.set('citas real', {
            currency: false,
            aliases: [
                'citas'
            ]
        });
        data.set('citas meta', {
            currency: false,
            aliases: [
            ]
        });
        data.set('4/14 real', {
            currency: false,
            aliases: [
            ]
        });
        data.set('4/14 meta', {
            currency: false,
            aliases: [
            ]
        });
        data.set('referidos real', {
            currency: false,
            aliases: [
                'referidos'
            ]
        });
        data.set('referidos meta', {
            currency: false,
            aliases: [
            ]
        });
        data.set('n√∫mero de ventas real', {
            currency: false,
            aliases: [
                'n√∫mero de ventas',
                '# ventas real',
                '#ventas real',
                'numer de ventas real'
            ],
            maxExpected: 50,
            canBeGrouped: true,
            related: 'ventas real'
        });
        data.set('n√∫mero de ventas meta', {
            currency: false,
            aliases: [
                '# ventas meta',
                '#ventas meta'
            ],
            maxExpected: 100,
            canBeGrouped: true,
            related: 'ventas meta'
        });
        data.set('ventas real', {
            currency: true,
            aliases: [
                'monto de venta',
                'monto real',
                'importe real',
                'real monto',
                'monto'
            ],
            canBeGrouped: true
        });
        data.set('ventas agregado', {
            currency: true,
            aliases: [
                'venta agregado',
                'ventas de agregado',
                'importe de agregado'
            ],
            canBeGrouped: true
        });
        data.set('ventas meta', {
            currency: true,
            aliases: [
                'monto meta',
                'meta monto'
            ],
            canBeGrouped: true
        });
        data.set('nuevos pros', {
            currency: false,
            aliases: [
                'nuevos ptos reclutamiento',
                'nuevos ptos en reclutamiento',
                'nuevos para reclutamiento',
                'nuevos pro reclutamiento',
                'nvos pros reclutamiento'
            ]
        });
        data.set('reclutamiento calido', {
            currency: false,
            aliases: [
            ]
        });
        data.set('reclutamiento real', {
            currency: false,
            aliases: [
                'rrhh real',
                'rh'
            ]
        });
        data.set('meta de reclutamiento', {
            currency: false,
            aliases: [
                'meta rrhh',
                'meta reclutamiento',
                'meta de reclut'
            ]
        });
        data.set('entrevistas', {
            currency: false,
            aliases: [
                'enztrevistas'
            ]
        });
        data.set('invitaciones', {
            currency: false,
            aliases: [
            ]
        });
        data.set('ingresos', {
            currency: false,
            aliases: [
            ]
        });
        data.set('telemarketing', {
            currency: false,
            aliases: [
            ]
        });
        data.set('prospectadores', {
            currency: false,
            aliases: [
            ]
        });
        data.set('invitados', {
            currency: false,
            aliases: [
            ]
        });

        let keywords = new Map();
        data.forEach(function (value, key) {
            keywords.set(key, key);
            value.aliases.forEach(function (alias) {
                keywords.set(alias, key);
            });
        });
        let keywordsArray = [...keywords];
        let keywordsSorted = keywordsArray.sort(
            ([key1, value1], [key2, value2]) => key2.length - key1.length
        );
        keywords = new Map(keywordsSorted);

        let pesos = new Intl.NumberFormat('es-MX', {
            currency: 'MXN',
            style: 'currency',
        });

        function generateId() {
            let id = "";
            let characters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
            for(let i = 0; i < 12; i++) {
                id += characters.charAt(Math.floor(Math.random() * 36));
            }
            return id;
        }

        let counters;
        function initCounters() {
            counters = new Map();
            data.forEach(function (value, key) {
                let keyword = key.toLowerCase();
                let counter = {
                    id: generateId(),
                    key: key,
                    counter: 0,
                    elements: [],
                    currency: value.currency,
                    maxExpected: value.maxExpected,
                    canBeGrouped: value.canBeGrouped,
                    related: value.related
                };
                counters.set(keyword, counter);
            });
        }

        function clearLine(line) {
            line = line.replace(/\s+/g, ' ');

            line = line.replace('1Ô∏è‚É£', '1');
            line = line.replace('2Ô∏è‚É£', '2');
            line = line.replace('3Ô∏è‚É£', '3');
            line = line.replace('4Ô∏è‚É£', '4');
            line = line.replace('5Ô∏è‚É£', '5');
            line = line.replace('6Ô∏è‚É£', '6');
            line = line.replace('7Ô∏è‚É£', '7');
            line = line.replace('8Ô∏è‚É£', '8');
            line = line.replace('9Ô∏è‚É£', '9');
            line = line.replace('üîü', '10');
            line = line.replace('0Ô∏è‚É£', '0');

            return line.toLowerCase();
        }

        function getLineValue(line) {
            let quantity = parseInt(line.replace(/[^\d.-]/g, ''));
            return isNaN(quantity) ? 0 : quantity;
        }

        function getGroupedValues(i, originalLine, rightPart) {
            let delimiterPosition = rightPart.search('\\$');
            if(delimiterPosition != -1) {
                let groupedLeft = rightPart.substring(0, delimiterPosition);
                let groupedRight = rightPart.substring(delimiterPosition + 1, rightPart.length);
                let quantityLeft = parseInt(groupedLeft.replace(/[^\d.-]/g, ''));
                let quantityRight = parseInt(groupedRight.replace(/[^\d.-]/g, ''));
                return {
                    left: isNaN(quantityLeft) ? 1 : quantityLeft,
                    right: isNaN(quantityRight) ? 0 : quantityRight,
                    found: true
                };
            } else {
                return {
                    left: 0,
                    right: 0,
                    found: false
                };
            }
        }

        function assignValues(i, originalLine, counter, leftValue, rightValue) {
            let lineValue = (leftValue * rightValue);

            if(counter.maxExpected && lineValue > counter.maxExpected) {
                let relatedCounter = counters.get(counter.related);
                if(relatedCounter) {
                    counter.counter += leftValue;
                    counter.elements.push('<spam class="tag">[ENVIADO A GRUPO: <b>' + counter.related + '</b>]</spam> ' + originalLine);

                    relatedCounter.counter += lineValue;
                    relatedCounter.elements.push('<spam class="tag">[OBTENIDA DE GRUPO: <b>' + counter.key + '</b>]</spam> ' + originalLine);
                } else {
                    counter.counter += lineValue;
                    counter.elements.push(originalLine);
                }
            } else {
                counter.counter += lineValue;
                counter.elements.push(originalLine);
            }
        }

        function cleanCount() {
            initCounters();
            $('#info').val('');
            $('#results').text('');
            $('#discarded').text('');
        }

        $('#count').click(function() {
            let txt = $('#info').val();

            cleanCount();

            let lines = txt.split(/\n/);
            let discarded = '<ul>';

            for(let i = 0; i < lines.length; i++) {
                let originalLine = lines[i].trim();
                let line = originalLine;
                let accepted = false;

                if (!line && line.length == 0) {
                    continue;
                }

                keywords.forEach(function (value, key) {
                    if(accepted) {
                        return;
                    }

                    line = clearLine(line);

                    if(line.includes(key)) {
                        let position = line.search(key);
                        let rightPart = line.substring(position + key.length, line.length);
                        let counter = counters.get(value);

                        if(counter.canBeGrouped) {
                            let grouped = getGroupedValues(i, originalLine, rightPart);
                            if(grouped.found) {
                                assignValues(i, originalLine, counter, grouped.left, grouped.right);
                            } else {
                                let lineValue = getLineValue(rightPart);
                                assignValues(i, originalLine, counter, 1, lineValue);
                            }
                        } else {
                            let lineValue = getLineValue(rightPart);
                            assignValues(i, originalLine, counter, 1, lineValue);
                        }

                        accepted = true;
                    }
                });

                if(!accepted) {
                    discarded += '<li>' + originalLine + '</li>';
                }
            }
            discarded += '</ul>'

            let results = '<table>';
            counters.forEach(function (value, key) {
                results += '<tr>';
                results += '<td>' + key + '</td>';
                if(value.currency) {
                    results += '<td>' + pesos.format(value.counter) + '</td>';
                } else {
                    results += '<td>' + value.counter + '</td>';
                }
                results += '<td>';
                results += '<button id="details-' + value.id + '">Detalle</button>';
                results += '<button id="hide-' + value.id + '">Ocultar</button>';
                results += '<ul id="list-' + value.id + '">';
                value.elements.forEach(function (element) {
                    results += '<li>' + element + '</li>';
                });
                results += '</ul>';
                results += '</td>';
                results += '</tr>';
            });
            results += "</table>"

            $('#results').html(results);
            $('#discarded').html(discarded);

            counters.forEach(function (value, key) {
                $("#list-" + value.id).hide();
                $("#hide-" + value.id).hide();

                $("#details-" + value.id).click(function(){
                    $("#list-" + value.id).show();
                    $("#details-" + value.id).hide();
                    $("#hide-" + value.id).show();
                });

                $("#hide-" + value.id).click(function(){
                    $("#list-" + value.id).hide();
                    $("#details-" + value.id).show();
                    $("#hide-" + value.id).hide();
                });
            });
        });

        $('#clean').click(function() {
            cleanCount();
        });

        initCounters();
    });
</script>
<style>
    footer {
        text-align: center;
        color: gray;
    }

    .tag {
        color: orange;
    }
</style>
</head>
<body>

<h3>Analizador de informes</h3>

<p>Pega los informes en la caja de texto</p>

<textarea id="info" rows="10" cols="50">
</textarea>

<br>
<button id="count">Contar</button>
<button id="clean">Limpiar</button>

<h4>Resultados</h4>
<div id="results"></div>

<h4>L√≠neas no le√≠das</h4>
<div id="discarded"></div>

<footer>
    <p>2022.03.14.18.55</p>
</footer>

</body>
</html>
